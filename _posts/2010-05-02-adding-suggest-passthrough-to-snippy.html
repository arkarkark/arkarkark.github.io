---
comments: false
date: 2010-05-02
layout: post
permalink: /2010/05/adding-suggest-passthrough-to-snippy.html
tags:
- appengine
- search
- snippy
title: adding suggest passthrough to snippy
---

<h1>{{ page.title }}</h1>
<div class='post'>
Bear with me, this is going to be a long one.<br /><div><br />Ever since I changed my default search engine to my own <a href="http://blog.wtwf.com/2010/04/snippy-urls-in-app-engine.html">snippy url shortner</a> I've only missed one feature. The suggest as you type from the original omnibox. I was fairly sure I could make it work though and today I got it working. But not without a lot of problems on the way.<br /><br />First of all, the suggest as you type feature is part of <a href="http://www.opensearch.org/Specifications/OpenSearch/Extensions/Suggestions">opensearch</a>. There is a url you hit with your partial search and it returns a bunch of&nbsp;suggestions&nbsp;as a small json reply.<br /><br />Unfortunately when you specify a Search Engine in google chrome there is no where to enter a suggest url (it is pretty complex and maybe only 10 people would ever want to do that). so I had to find another way to get it into Google Chrome. Fortunately there's TWO ways to add it.<br /><br />First you can put a <a href="http://www.opensearch.org/Specifications/OpenSearch/1.1#Autodiscovery_in_HTML.2FXHTML">little element</a> at the top of your XML and the browser should pick this up and add it to the list of options. Sadly I never got this working with Chrome.<br /><br />The other way is with a&nbsp;window.external.AddSearchProvider javascript call, you need to give a full url to this method and after a lot of work I found two problems. My XML had an empty Image element which <a href="http://code.google.com/p/chromium/issues/detail?id=42767">caused Chrome to choke</a> and then I also found out that this javascript method <a href="http://code.google.com/p/chromium/issues/detail?id=29732">doesn't work on Mac Chrome</a> currently. What a pain, Mac is my primary development environment. Chrome is pretty awful about telling you <a href="http://code.google.com/p/chromium/issues/detail?id=6792">when adding a search provider fails</a>.<br /><br />I played around with it a while and finally found a way to do it on Mac. In&nbsp;</div><div>~/Library/Application Support/Google/Chrome/Default/<wbr></wbr>Preferences I found:<br /><br /><pre></pre></div><div><div>"default_search_provider": {</div><div>&nbsp;&nbsp; &nbsp; &nbsp;"id": "5",</div><div>&nbsp;&nbsp; &nbsp; &nbsp;"name": "snippy",</div><div>&nbsp;&nbsp; &nbsp; &nbsp;"prepopulate_id": "0",</div><div>&nbsp;&nbsp; &nbsp; &nbsp;"search_url": "http://exmaple.com/{<wbr></wbr>searchTerms}",</div><div>&nbsp;&nbsp; &nbsp; &nbsp;"<span class="il" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial;"><span class="Apple-style-span" style="background-color: white;">sugges</span></span><span class="il" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial;"><span class="Apple-style-span" style="background-color: white;">t_url":&nbsp;</span></span><span class="Apple-style-span" style="background-color: white;">""</span></div><div>&nbsp;&nbsp; },</div></div><div><br /></div><div>and I just want to fill in<span class="Apple-style-span" style="background-color: white;"> that&nbsp;</span><span class="il" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial;"><span class="Apple-style-span" style="background-color: white;">suggest_url</span></span></div><div><br /></div><div>I quit all Chromes, edited it and restarted Chrome and tahdah, the file got reverted to what it was set to before :(</div><div><br /></div><div>so I had a poke around and found Web\ Data had what I wanted in it</div><div># sqlite3 Web\ Data</div><div><br /></div><div>UPDATE keywords SET&nbsp;<span class="il" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial;"><span class="Apple-style-span" style="background-color: white;">suggest_url</span></span>&nbsp;= '<a href="http://app.wtwf.com/admin/suggest?q=%7BsearchTerms%7D" style="color: #112508;" target="_blank">http://example.com/admin/<wbr></wbr>suggest?q={searchTerms}</a>' WHERE id = 5;</div><div><br />And it worked! now Chrome was hitting my suggest url when I was typing in the omnibox!<br /><br /><br /><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">Remember with my url shortner I can type [g something] and that will search Google for [something]</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">My first plan was to pick up the short url I was typing, look up the suggest url and just redirect them, but alas the returned json has the search query in it [something[, and not the short url plus the search query [g something]. Seems Chrome is a little picky about what responses it actually accepts and the search query must match what's in the omnibox.</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">So I moved over to actually requesting the suggest url and fudging with the json reply to add the short url keyword and then returning that. Worked great.</div><br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/_P1IABrKRUwU/S9_D01kg9gI/AAAAAAAAUbM/LLZqZjkiSMM/s1600/screenshot_01.jpg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="233" src="http://1.bp.blogspot.com/_P1IABrKRUwU/S9_D01kg9gI/AAAAAAAAUbM/LLZqZjkiSMM/s320/screenshot_01.jpg" width="320" /></a></div>For the main google search I managed to find <a href="http://customsearchprovider.appspot.com/">the suggest url</a> on this page and that worked great. Then I had to find the other suggesty urls. Google News was my first attempt, I loaded google news opened up the javascript console and turned on resource tracking, then started typing, sure enough at the bottom of the resources it showed the search urls being hit. I could hit headers and copy/paste the full url. and add it to snippy. A screenshot is left.<br /><br />But of course nothing is easy, Google News sends results back in a different JSON format, Google Images sends back results as JSONP and also the results have bold elements in it which need to be stripped out for Chrome. But I managed to strip it out and it's working.<br /><br />Eventually I expect to allow you to add OpenSearch Description Documents directly which'll be kinda neat.<br /><br />I also plan to allow me to specify 'promoted or super-public' snippy urls which can be displayed on a page and easily exported for other users to use.<br /><br />One problem is, since the appengine app actually requests the suggest url, there are no cookies sent along with it to identify you which means the results can't be personalized by the server, which is annoying, not that I know any that do it.</div></div>
<h2>Comments</h2>
<div class='comments'>
</div>
